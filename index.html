<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>Lersense Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root {
      --primary: #A57BD1;
      --secondary: #F3E5F5;
      --gold: #C5A059;
      --dark: #4a4a4a;
    }
    body { font-family: 'Prompt', sans-serif; background-color: #FAFAFA; color: var(--dark); margin: 0; padding-bottom: 50px; }
    
    .header-bg {
      background: linear-gradient(135deg, #BFA2DB 0%, #A57BD1 100%);
      color: white; padding: 30px 20px;
      border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
      text-align: center; box-shadow: 0 4px 15px rgba(165, 123, 209, 0.3);
    }
    
    .container { max-width: 500px; margin-top: -30px; position: relative; z-index: 10; padding: 0 20px; }
    
    .card-custom {
      background: white; border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
      padding: 25px; margin-bottom: 20px;
    }

    .form-control, .form-select { border-radius: 12px; padding: 12px; border: 1px solid #eee; }
    .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(165, 123, 209, 0.1); }
    
    .btn-main {
      background: linear-gradient(to right, var(--gold), #D4AF37);
      border: none; color: white; font-weight: 600; padding: 14px;
      border-radius: 12px; width: 100%; box-shadow: 0 4px 10px rgba(197, 160, 89, 0.4);
      cursor: pointer;
    }
    .btn-main:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

    #loading {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(255,255,255,0.95); z-index: 9999;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
    }
    .spinner {
      width: 40px; height: 40px; border: 4px solid var(--secondary);
      border-top: 4px solid var(--primary); border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loading">
    <div class="spinner"></div>
    <div class="mt-3 text-muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  </div>

  <div class="header-bg">
    <h2 style="font-weight: 600; letter-spacing: 1px;">LERSENSE</h2>
    <p style="font-size: 0.9rem; opacity: 0.9;">Exclusive Massage & Spa</p>
  </div>

  <div class="container">
    
    <div id="loginSection" class="card-custom text-center" style="display:none; margin-top: 20px;">
      <h4>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h4>
      <p class="text-muted">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ LINE ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß</p>
      <button onclick="liff.login()" class="btn btn-success w-100 py-3 mt-2" style="border-radius:12px;">Login with LINE</button>
    </div>

    <div id="formSection" class="card-custom" style="display:none;">
      <form id="bookingForm" onsubmit="submitForm(event)">
        <input type="hidden" id="userId" name="userId">
        
        <div class="row g-2 mb-3">
          <div class="col-6">
            <label class="form-label text-muted small">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á (Name)</label>
            <input type="text" class="form-control" name="name" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏ä‡∏≠‡∏ö‡∏ô‡∏ß‡∏î">
          </div>
          <div class="col-6">
            <label class="form-label text-muted small">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (Phone Number)</label>
            <input type="tel" class="form-control" name="phone" required placeholder="08x-xxxxxxx">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ Service</label>
          <select class="form-select" id="serviceSelect" name="serviceName" required onchange="calcTime()">
            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£...</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (Location)</label>
          <select class="form-select" id="locationSelect" name="locationName" required>
            <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (Select)</option>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label text-muted small">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏î‡∏π‡πÅ‡∏• (Staff)</label>
          <select class="form-select" id="staffSelect" name="staffName" required>
            <option value="" disabled selected>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</option>
          </select>
        </div>

        <hr style="opacity:0.1">

        <div class="mb-4">
          <label class="form-label text-muted small">‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
          <div class="row g-2">
            <div class="col-7">
              <input type="date" class="form-control" name="date" required>
            </div>
            <div class="col-5">
              <input type="time" class="form-control" id="timeInput" name="time" required onchange="calcTime()">
            </div>
          </div>
          <div class="text-end mt-2">
            <small id="timeDisplay" style="color:var(--primary); font-weight:500;"></small>
          </div>
        </div>

        <button type="submit" id="submitBtn" class="btn-main">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á (Send)</button>
      </form>
    </div>

    <div id="successSection" class="card-custom text-center" style="display:none;">
      <div style="font-size: 50px;">‚úÖ</div>
      <h4 class="mt-3 text-success">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h4>
      <p class="text-muted mt-2 small">
        ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
      </p>
      
      <div class="alert alert-warning p-2 small">
        ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô<br>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
      </div>

      <button onclick="sendDepositMessage()" class="btn-main mt-2">
        üí≥ ‡πÅ‡∏à‡πâ‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥
      </button>
    </div>

  </div>

  <script>
    // ================= CONFIG =================
    const CONFIG = {
      LIFF_ID: "2008899579-4H1nxNds", 
      // *** ‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
      API_URL: "https://script.google.com/macros/s/AKfycbyDwLQ29381OQ6tagrKUdjZ_Ped0IcDwiprwOloSvVn2Z3vJQM6yvfacXrbO8KE_KY/exec" 
    };
    // ==========================================

    let servicesData = [];

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
    window.onload = async function() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        if (liff.isLoggedIn()) {
          initializeApp();
        } else {
          document.getElementById('loading').style.display = 'none';
          document.getElementById('loginSection').style.display = 'block';
        }
      } catch (err) {
        alert("LIFF Error: " + err.message);
        document.getElementById('loading').style.display = 'none';
      }
    };

    async function initializeApp() {
      try {
        const profile = await liff.getProfile();
        document.getElementById('userId').value = profile.userId;

        // 1. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
        const memberRes = await fetch(`${CONFIG.API_URL}?op=checkMember&userId=${profile.userId}&displayName=${encodeURIComponent(profile.displayName)}&pictureUrl=${encodeURIComponent(profile.pictureUrl)}`);
        const memberData = await memberRes.json();
        
        if (!memberData.isNew && memberData.userData) {
          document.getElementsByName('name')[0].value = memberData.userData.name;
          document.getElementsByName('phone')[0].value = memberData.userData.phone;
        }

        // 2. ‡∏î‡∏∂‡∏á Dropdown
        const ddRes = await fetch(CONFIG.API_URL);
        const data = await ddRes.json();
        
        const svc = document.getElementById('serviceSelect');
        servicesData = data.services;
        data.services.forEach(s => svc.add(new Option(`${s[0]} (${s[1]}‡∏ô.) - ${s[2]}‡∏ø`, s[0])));

        const loc = document.getElementById('locationSelect');
        data.locations.forEach(l => loc.add(new Option(l[0], l[0])));

        const stf = document.getElementById('staffSelect');
        stf.innerHTML = '<option value="random" selected>‚ú® ‡∏™‡∏∏‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>';
        data.staff.forEach(s => stf.add(new Option(`‡∏Ñ‡∏∏‡∏ì ${s[0]}`, s[0])));

        document.getElementById('loading').style.display = 'none';
        document.getElementById('formSection').style.display = 'block';

      } catch (e) {
        alert("Load Data Error: " + e.message);
        document.getElementById('loading').style.display = 'none';
      }
    }

    function calcTime() {
      const sName = document.getElementById('serviceSelect').value;
      const tInput = document.getElementById('timeInput').value;
      if(!sName || !tInput) return;

      const service = servicesData.find(s => s[0] === sName);
      if(service) {
        const duration = parseInt(service[1]);
        let [h, m] = tInput.split(':').map(Number);
        let d = new Date(); d.setHours(h, m + duration);
        let endT = `${('0'+d.getHours()).slice(-2)}:${('0'+d.getMinutes()).slice(-2)}`;
        document.getElementById('timeDisplay').innerText = `‚è±Ô∏è ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ${duration} ‡∏ô‡∏≤‡∏ó‡∏µ (‡πÄ‡∏™‡∏£‡πá‡∏à ${endT})`;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏î‡∏à‡∏≠‡∏á
    async function submitForm(e) {
      e.preventDefault();
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('submitBtn').disabled = true;

      const form = document.getElementById('bookingForm');
      const formData = {};
      new FormData(form).forEach((v, k) => formData[k] = v);

      try {
        const res = await fetch(CONFIG.API_URL, {
          method: 'POST',
          body: JSON.stringify(formData)
        });
        const result = await res.json();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('submitBtn').disabled = false;

        if(result.status === 'success') {
          // ‡∏ã‡πà‡∏≠‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° -> ‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏°‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô
          document.getElementById('formSection').style.display = 'none';
          document.getElementById('successSection').style.display = 'block';
        } else {
          alert("‚ö†Ô∏è " + result.message);
        }
      } catch (err) {
        alert("Submit Error: " + err);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('submitBtn').disabled = false;
      }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏°‡∏±‡∏î‡∏à‡∏≥
    function sendDepositMessage() {
      if (!liff.isInClient()) {
        alert("‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ö‡∏ô‡πÅ‡∏≠‡∏õ LINE ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");
        return;
      }
      
      liff.sendMessages([{
        type: 'text',
        text: '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥'
      }])
      .then(() => {
        liff.closeWindow();
      })
      .catch((err) => {
        console.log('Error:', err);
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥' ‡πÄ‡∏≠‡∏á‡∏Ñ‡∏£‡∏±‡∏ö)");
        liff.closeWindow();
      });
    }
  </script>
</body>
</html>
